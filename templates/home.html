{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Dashboard</h3>
  <a class="btn btn-primary" href="{{ url_for('customers_new') }}">+ Customer</a>
</div>

<!-- KPI cards -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="text-muted">Total Prospek</div>
        <div class="display-6">{{ dashboard.total if dashboard else customers_count }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="text-muted">Closing Berhasil</div>
        <div class="display-6">{{ dashboard.won_count if dashboard else 0 }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="text-muted">Closing Gagal</div>
        <div class="display-6">{{ dashboard.lost_count if dashboard else 0 }}</div>
      </div>
    </div>
  </div>
</div>

{% if dashboard %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Charts -->
  <div class="row g-3 mb-4">

    <!-- Row 1: 3 pies -->
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Prospek Berhasil vs Gagal</h6>
          <canvas id="pieWonLost"></canvas>
          <div class="text-muted small mt-2">
            Total closing: {{ dashboard.won_count + dashboard.lost_count }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">% Closing vs Total Prospek</h6>
          <canvas id="pieWonTotal"></canvas>
          <div class="text-muted small mt-2">
            Closing: {{ dashboard.won_count }} / {{ dashboard.total }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">% Gagal Closing vs Total Prospek</h6>
          <canvas id="pieLostTotal"></canvas>
          <div class="text-muted small mt-2">
            Gagal: {{ dashboard.lost_count }} / {{ dashboard.total }}
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2: 2 pies -->
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Estimasi Nilai: Sukses vs Gagal</h6>
          <canvas id="pieValue"></canvas>
          <div class="text-muted small mt-2">
            Sukses: {{ fmt_idr(dashboard.won_value) }} • Gagal: {{ fmt_idr(dashboard.lost_value) }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Estimasi Nilai: Sudah Penawaran vs Belum</h6>
          <canvas id="pieOfferValue"></canvas>
          <div class="text-muted small mt-2">
            Sudah Penawaran dihitung dari Progress yang mengandung kata: Proposal / Penawaran / Quotation / Offer.
          </div>
        </div>
      </div>
    </div>

    <!-- Row 4: bar chart full width -->
    <div class="col-12">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Top Sales (Sukses Closing)</h6>
          <canvas id="barTopSales" style="max-height: 340px;"></canvas>
          <div class="text-muted small mt-2">
            Menampilkan maksimum 10 sales.
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header">
            Reminder Follow Up Minggu Ini ({{ week_start }} s/d {{ week_end }})
          </div>
          <div class="card-body">
            {% if followup_week %}
              <div class="list-group">
                {% for c in followup_week %}
                  <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                    href="{{ url_for('customer_detail', customer_id=c.id) }}">
                  <div>
                    <div class="fw-semibold">{{ c.name }}</div>
                    <div class="text-muted small">
                      Sales: {{ c.salesman_name or "-" }} • Progress: {{ c.progress.name if c.progress else "-" }}
                    </div>
                  </div>
                  <div class="text-muted small">
                    {{ c.prospect_next_followup_date.strftime("%Y-%m-%d") if c.prospect_next_followup_date else "-" }}
                  </div>
                </a>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">Tidak ada follow up terjadwal minggu ini.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Top Sumber Prospek yang Menghasilkan Closing</div>
        <div class="card-body">
          {% if top_sources_won_labels and top_sources_won_values %}
            <canvas id="barTopSourcesWon"></canvas>
            <div class="text-muted small mt-2">Berdasarkan jumlah closing sukses (Top 10).</div>
          {% else %}
            <div class="text-muted">Belum ada data closing sukses.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>


  <script>
    const d = {{ dashboard|tojson }};

    function makePie(id, labels, values) {
      const el = document.getElementById(id);
      if (!el) return;
      new Chart(el, {
        type: 'pie',
        data: { labels: labels, datasets: [{ data: values }] },
        options: { responsive: true }
      });
    }

    function makeBar(id, labels, values) {
      const el = document.getElementById(id);
      if (!el) return;
      new Chart(el, {
        type: 'bar',
        data: { labels: labels, datasets: [{ label: 'Jumlah Closing Sukses', data: values }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }

    const TOP_SRC_LABELS = {{ (top_sources_won_labels or [])|tojson }};
    const TOP_SRC_VALUES = {{ (top_sources_won_values or [])|tojson }};

    if (document.getElementById("barTopSourcesWon") && TOP_SRC_LABELS.length) {
      new Chart(document.getElementById("barTopSourcesWon"), {
        type: "bar",
        data: { labels: TOP_SRC_LABELS, datasets: [{ label: "Jumlah Closing Sukses", data: TOP_SRC_VALUES }] },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }

    // pies dari dashboard
    makePie('pieWonLost', ['Berhasil', 'Gagal'], [d.won_count, d.lost_count]);
    makePie('pieWonTotal', ['Closing', 'Belum Closing'], [d.won_count, d.not_won]);
    makePie('pieLostTotal', ['Gagal', 'Bukan Gagal'], [d.lost_count, d.not_lost]);
    makePie('pieValue', ['Estimasi Sukses', 'Estimasi Gagal'], [d.won_value, d.lost_value]);

    // bar top sales
    makeBar('barTopSales', d.top_sales_labels || [], d.top_sales_values || []);

    // pies dari masters
    const PIE_SOURCES_LABELS = {{ (pie_sources_labels or [])|tojson }};
    const PIE_SOURCES_VALUES = {{ (pie_sources_values or [])|tojson }};
    if (PIE_SOURCES_LABELS.length) makePie('pieSources', PIE_SOURCES_LABELS, PIE_SOURCES_VALUES);

    const PIE_NEEDS_LABELS = {{ (pie_needs_labels or [])|tojson }};
    const PIE_NEEDS_VALUES = {{ (pie_needs_values or [])|tojson }};
    if (PIE_NEEDS_LABELS.length) makePie('pieNeeds', PIE_NEEDS_LABELS, PIE_NEEDS_VALUES);

    // pie offer vs not offer (estimasi nilai)
    const PIE_OFFER_LABELS = {{ (pie_offer_labels or [])|tojson }};
    const PIE_OFFER_VALUES = {{ (pie_offer_values or [])|tojson }};
    if (PIE_OFFER_LABELS.length) makePie('pieOfferValue', PIE_OFFER_LABELS, PIE_OFFER_VALUES);
  </script>
{% endif %}

<!-- Followups -->
<div class="card">
  <div class="card-header">Follow Up Terbaru</div>
  <div class="card-body">
    {% if latest_followups %}
      <ul class="list-group">
        {% for fu in latest_followups %}
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <div>
                <a href="{{ url_for('customer_detail', customer_id=fu.customer_id) }}">
                  {{ fu.customer.name }}
                </a>
                {% if fu.stage %}<span class="badge badge-accent">{{ fu.stage.name }}</span>{% endif %}
              </div>
              <div class="text-muted small">{{ fu.note or "-" }}</div>
            </div>
            <div class="text-muted small">{{ fu.created_at.strftime("%Y-%m-%d %H:%M") }}</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Belum ada follow up.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
