{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Dashboard</h3>
  <a class="btn btn-primary" href="{{ url_for('customers_new') }}">+ Customer</a>
</div>

<!-- KPI cards -->
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="text-muted">Total Prospek</div>
        <div class="display-6">{{ dashboard.total if dashboard else customers_count }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="text-muted">Closing Berhasil</div>
        <div class="display-6">{{ dashboard.won_count if dashboard else 0 }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="text-muted">Closing Gagal</div>
        <div class="display-6">{{ dashboard.lost_count if dashboard else 0 }}</div>
      </div>
    </div>
  </div>
</div>

{% if dashboard %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .chart-box { height: 280px; }
    .chart-box.tall { height: 320px; }
    .chart-box.bar { height: 360px; }
    .card h6 { font-weight: 700; }
  </style>

  <!-- ROW 1: 3 donuts -->
  <div class="row g-3 mb-3">
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Prospek Berhasil vs Gagal</h6>
          <div class="chart-box"><canvas id="pieWonLost"></canvas></div>
          <div class="text-muted small mt-2">
            Total closing: {{ dashboard.won_count + dashboard.lost_count }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">% Closing vs Total Prospek</h6>
          <div class="chart-box"><canvas id="pieWonTotal"></canvas></div>
          <div class="text-muted small mt-2">
            Closing: {{ dashboard.won_count }} / {{ dashboard.total }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">% Gagal Closing vs Total Prospek</h6>
          <div class="chart-box"><canvas id="pieLostTotal"></canvas></div>
          <div class="text-muted small mt-2">
            Gagal: {{ dashboard.lost_count }} / {{ dashboard.total }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ROW 2: 2 donuts nilai -->
  <div class="row g-3 mb-3">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Estimasi Nilai: Sukses vs Gagal</h6>
          <div class="chart-box tall"><canvas id="pieValue"></canvas></div>
          <div class="text-muted small mt-2">
            Sukses: {{ fmt_idr(dashboard.won_value) }} • Gagal: {{ fmt_idr(dashboard.lost_value) }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Estimasi Nilai: Sudah Penawaran vs Belum</h6>
          <div class="chart-box tall"><canvas id="pieOfferValue"></canvas></div>
          <div class="text-muted small mt-2">
            Sudah Penawaran dihitung dari Progress yang mengandung kata: Proposal / Penawaran / Quotation / Offer.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ROW 3: bar top sales full width -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Top Sales (Sukses Closing)</h6>
          <div class="chart-box bar"><canvas id="barTopSales"></canvas></div>
          <div class="text-muted small mt-2">Menampilkan maksimum 10 sales.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ROW 4: Reminder + Top sumber closing -->
  <div class="row g-3 mb-3">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">
          Reminder Follow Up Minggu Ini ({{ week_start }} s/d {{ week_end }})
        </div>
        <div class="card-body">
          {% if followup_week %}
            <div class="list-group">
              {% for c in followup_week %}
                <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                   href="{{ url_for('customer_detail', customer_id=c.id) }}">
                  <div>
                    <div class="fw-semibold">{{ c.name }}</div>
                    <div class="text-muted small">
                      Sales: {{ c.salesman_name or "-" }} • Progress: {{ c.progress.name if c.progress else "-" }}
                    </div>
                  </div>
                  <div class="text-muted small">
                    {{ c.prospect_next_followup_date.strftime("%Y-%m-%d") if c.prospect_next_followup_date else "-" }}
                  </div>
                </a>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">Tidak ada follow up terjadwal minggu ini.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">Top Sumber Prospek yang Menghasilkan Closing</div>
        <div class="card-body">
          {% if top_sources_won_labels and top_sources_won_values %}
            <div class="chart-box bar" style="height:320px;"><canvas id="barTopSourcesWon"></canvas></div>
            <div class="text-muted small mt-2">Berdasarkan jumlah closing sukses (Top 10).</div>
          {% else %}
            <div class="text-muted">Belum ada data closing sukses.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    const d = {{ dashboard|tojson }};

    // ---------- Format ----------
    function fmtIDR(n){
      const v = Number(n || 0);
      return new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 }).format(v);
    }

    // ---------- Fake 3D shadow plugin ----------
    const shadowPlugin = {
      id: 'shadowPlugin',
      beforeDatasetDraw(chart, args, opts) {
        const { ctx } = chart;
        ctx.save();
        ctx.shadowColor = (opts && opts.shadowColor) || 'rgba(0,0,0,0.28)';
        ctx.shadowBlur = (opts && opts.shadowBlur) ?? 14;
        ctx.shadowOffsetX = (opts && opts.shadowOffsetX) ?? 0;
        ctx.shadowOffsetY = (opts && opts.shadowOffsetY) ?? 8;
      },
      afterDatasetDraw(chart) { chart.ctx.restore(); }
    };

    // ---------- Premium donut options ----------
    function donutOptions(isValue=false){
      return {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        layout: { padding: 10 },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              pointStyle: 'circle',
              boxWidth: 8,
              padding: 14,
              font: { size: 12, weight: '600' }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(20,20,20,.92)',
            titleColor: '#fff',
            bodyColor: '#fff',
            padding: 10,
            cornerRadius: 10,
            callbacks: {
              label: function(ctx){
                const val = ctx.raw ?? 0;
                const total = (ctx.dataset.data || []).reduce((a,b)=>a+Number(b||0),0) || 1;
                const pct = Math.round((Number(val)/total)*100);
                const shown = isValue ? fmtIDR(val) : Number(val).toLocaleString('id-ID');
                return ` ${ctx.label}: ${shown} (${pct}%)`;
              }
            }
          }
        },
        animation: { duration: 850, easing: 'easeOutQuart' }
      };
    }

    // ---------- Gradients ----------
    function makeGradients(chart, count){
      const { ctx, chartArea } = chart;
      if (!chartArea) return Array.from({length:count}, ()=> undefined);

      const base = [
        ['#ff7a00', '#ffb36b'],
        ['#22c55e', '#86efac'],
        ['#ef4444', '#fca5a5'],
        ['#3b82f6', '#93c5fd'],
        ['#a855f7', '#d8b4fe'],
        ['#14b8a6', '#99f6e4'],
        ['#f59e0b', '#fde68a'],
        ['#0ea5e9', '#bae6fd'],
        ['#64748b', '#cbd5e1'],
        ['#10b981', '#a7f3d0'],
      ];

      return Array.from({length:count}, (_,i)=>{
        const g = ctx.createLinearGradient(chartArea.left, chartArea.top, chartArea.right, chartArea.bottom);
        const pair = base[i % base.length];
        g.addColorStop(0, pair[0]);
        g.addColorStop(1, pair[1]);
        return g;
      });
    }

    // ---------- Donut builder ----------
    function makeDonut(id, labels, values, isValue=false){
      const el = document.getElementById(id);
      if (!el) return;

      const chart = new Chart(el, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, borderWidth: 0, hoverOffset: 10 }] },
        plugins: [shadowPlugin],
        options: donutOptions(isValue)
      });

      chart.data.datasets[0].backgroundColor = makeGradients(chart, values.length);
      chart.update();
    }

    // ---------- Bar builder ----------
    function makeBarModern(id, labels, values, labelName){
      const el = document.getElementById(id);
      if (!el) return;

      new Chart(el, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: labelName || 'Jumlah',
            data: values,
            borderWidth: 0,
            borderRadius: 12
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(20,20,20,.92)',
              titleColor: '#fff',
              bodyColor: '#fff',
              padding: 10,
              cornerRadius: 10
            }
          },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true, ticks: { precision: 0 }, grid: { color: 'rgba(0,0,0,.08)' } }
          }
        }
      });
    }

    // ===== Donuts (existing charts tetap ada) =====
    makeDonut('pieWonLost', ['Berhasil', 'Gagal'], [d.won_count, d.lost_count], false);
    makeDonut('pieWonTotal', ['Closing', 'Belum Closing'], [d.won_count, d.not_won], false);
    makeDonut('pieLostTotal', ['Gagal', 'Bukan Gagal'], [d.lost_count, d.not_lost], false);
    makeDonut('pieValue', ['Estimasi Sukses', 'Estimasi Gagal'], [d.won_value, d.lost_value], true);

    const PIE_OFFER_LABELS = {{ (pie_offer_labels or [])|tojson }};
    const PIE_OFFER_VALUES = {{ (pie_offer_values or [])|tojson }};
    if (PIE_OFFER_LABELS.length) makeDonut('pieOfferValue', PIE_OFFER_LABELS, PIE_OFFER_VALUES, true);

    // ===== Bars =====
    makeBarModern('barTopSales', d.top_sales_labels || [], d.top_sales_values || [], 'Jumlah Closing Sukses');

    const TOP_SRC_LABELS = {{ (top_sources_won_labels or [])|tojson }};
    const TOP_SRC_VALUES = {{ (top_sources_won_values or [])|tojson }};
    if (TOP_SRC_LABELS.length) makeBarModern('barTopSourcesWon', TOP_SRC_LABELS, TOP_SRC_VALUES, 'Jumlah Closing Sukses');
  </script>
{% endif %}

<!-- Followups -->
<div class="card">
  <div class="card-header">Follow Up Terbaru</div>
  <div class="card-body">
    {% if latest_followups %}
      <ul class="list-group">
        {% for fu in latest_followups %}
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <div>
                <a href="{{ url_for('customer_detail', customer_id=fu.customer_id) }}">
                  {{ fu.customer.name }}
                </a>
                {% if fu.stage %}<span class="badge badge-accent">{{ fu.stage.name }}</span>{% endif %}
              </div>
              <div class="text-muted small">{{ fu.note or "-" }}</div>
            </div>
            <div class="text-muted small">{{ fu.created_at.strftime("%Y-%m-%d %H:%M") }}</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Belum ada follow up.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
