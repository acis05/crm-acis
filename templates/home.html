{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Dashboard</h3>
  <a class="btn btn-primary" href="{{ url_for('customers_new') }}">+ Customer</a>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="text-muted">Total Prospek</div>
        <div class="display-6">{{ dashboard.total if dashboard else customers_count }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="text-muted">Closing Berhasil</div>
        <div class="display-6">{{ dashboard.won_count if dashboard else 0 }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="text-muted">Closing Gagal</div>
        <div class="display-6">{{ dashboard.lost_count if dashboard else 0 }}</div>
      </div>
    </div>
  </div>
</div>

{% if dashboard %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* bikin canvas punya tinggi stabil biar layout gak berantakan */
    .chart-box { height: 280px; }
    .chart-box.tall { height: 320px; }
  </style>

  <!-- Row 1: 3 donut utama -->
  <div class="row g-3 mb-3">
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Prospek Berhasil vs Gagal</h6>
          <div class="chart-box">
            <canvas id="pieWonLost"></canvas>
          </div>
          <div class="text-muted small mt-2">
            Total closing: {{ dashboard.won_count + dashboard.lost_count }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">% Closing vs Total Prospek</h6>
          <div class="chart-box">
            <canvas id="pieWonTotal"></canvas>
          </div>
          <div class="text-muted small mt-2">
            Closing: {{ dashboard.won_count }} / {{ dashboard.total }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">% Gagal Closing vs Total Prospek</h6>
          <div class="chart-box">
            <canvas id="pieLostTotal"></canvas>
          </div>
          <div class="text-muted small mt-2">
            Gagal: {{ dashboard.lost_count }} / {{ dashboard.total }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 2: value donut + offer donut -->
  <div class="row g-3 mb-3">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Estimasi Nilai: Sukses vs Gagal</h6>
          <div class="chart-box tall">
            <canvas id="pieValue"></canvas>
          </div>
          <div class="text-muted small mt-2">
            Sukses: {{ fmt_idr(dashboard.won_value) }} â€¢ Gagal: {{ fmt_idr(dashboard.lost_value) }}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Estimasi Nilai (Sudah Penawaran vs Belum)</h6>
          <div class="chart-box tall">
            <canvas id="pieOfferValue"></canvas>
          </div>
          <div class="text-muted small mt-2">
            Sudah Penawaran dihitung dari Progress yang mengandung kata: Proposal / Penawaran / Quotation / Offer.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Row 3: sources + needs -->
  <div class="row g-3 mb-3">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Sumber Prospek</h6>
          {% if pie_sources_labels and pie_sources_values %}
            <div class="chart-box">
              <canvas id="pieSources"></canvas>
            </div>
          {% else %}
            <div class="text-muted">Belum ada data sumber prospek.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Produk/Jasa Dibutuhkan</h6>
          {% if pie_needs_labels and pie_needs_values %}
            <div class="chart-box">
              <canvas id="pieNeeds"></canvas>
            </div>
          {% else %}
            <div class="text-muted">Belum ada data produk/jasa.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Row 4: bar top sales -->
  <div class="row g-3 mb-4">
    <div class="col-lg-12">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Top Sales (Sukses Closing)</h6>
          <div style="height: 360px;">
            <canvas id="barTopSales"></canvas>
          </div>
          <div class="text-muted small mt-2">
            Menampilkan maksimum 10 sales.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const d = {{ dashboard|tojson }};

    // ---------- Helper format ----------
    function fmtIDR(n){
      const v = Number(n || 0);
      return new Intl.NumberFormat('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 }).format(v);
    }

    // ---------- Fake 3D shadow plugin ----------
    const shadowPlugin = {
      id: 'shadowPlugin',
      beforeDatasetDraw(chart, args, opts) {
        const { ctx } = chart;
        ctx.save();
        ctx.shadowColor = (opts && opts.shadowColor) || 'rgba(0,0,0,0.28)';
        ctx.shadowBlur = (opts && opts.shadowBlur) ?? 14;
        ctx.shadowOffsetX = (opts && opts.shadowOffsetX) ?? 0;
        ctx.shadowOffsetY = (opts && opts.shadowOffsetY) ?? 8;
      },
      afterDatasetDraw(chart) {
        chart.ctx.restore();
      }
    };

    // ---------- Premium donut options ----------
    const premiumDonutOptions = (isValue=false) => ({
      responsive: true,
      maintainAspectRatio: false,
      cutout: '70%',
      layout: { padding: 10 },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            pointStyle: 'circle',
            boxWidth: 8,
            padding: 14,
            font: { size: 12, weight: '600' }
          }
        },
        tooltip: {
          backgroundColor: 'rgba(20,20,20,.92)',
          titleColor: '#fff',
          bodyColor: '#fff',
          padding: 10,
          cornerRadius: 10,
          callbacks: {
            label: function(ctx){
              const val = ctx.raw ?? 0;
              const total = (ctx.dataset.data || []).reduce((a,b)=>a+Number(b||0),0) || 1;
              const pct = Math.round((Number(val)/total)*100);
              const shown = isValue ? fmtIDR(val) : Number(val).toLocaleString('id-ID');
              return ` ${ctx.label}: ${shown} (${pct}%)`;
            }
          }
        }
      },
      animation: { duration: 900, easing: 'easeOutQuart' }
    });

    // ---------- Gradient palette ----------
    function makeGradients(chart, count){
      const { ctx, chartArea } = chart;
      if (!chartArea) return Array.from({length:count}, ()=> undefined);

      const base = [
        ['#ff7a00', '#ffb36b'],
        ['#22c55e', '#86efac'],
        ['#ef4444', '#fca5a5'],
        ['#3b82f6', '#93c5fd'],
        ['#a855f7', '#d8b4fe'],
        ['#14b8a6', '#99f6e4'],
        ['#f59e0b', '#fde68a'],
        ['#0ea5e9', '#bae6fd'],
        ['#64748b', '#cbd5e1'],
        ['#10b981', '#a7f3d0'],
      ];

      return Array.from({length:count}, (_,i)=>{
        const g = ctx.createLinearGradient(chartArea.left, chartArea.top, chartArea.right, chartArea.bottom);
        const pair = base[i % base.length];
        g.addColorStop(0, pair[0]);
        g.addColorStop(1, pair[1]);
        return g;
      });
    }

    // ---------- Builder donut ----------
    function buildDonut(canvasId, labels, values, isValue=false){
      const el = document.getElementById(canvasId);
      if (!el) return;

      const chart = new Chart(el, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data: values,
            borderWidth: 0,
            hoverOffset: 8
          }]
        },
        plugins: [shadowPlugin],
        options: premiumDonutOptions(isValue)
      });

      // apply gradient after chart area is ready
      chart.data.datasets[0].backgroundColor = makeGradients(chart, values.length);
      chart.update();
    }

    // ---------- Donuts ----------
    buildDonut('pieWonLost', ['Berhasil', 'Gagal'], [d.won_count, d.lost_count], false);
    buildDonut('pieWonTotal', ['Closing', 'Belum Closing'], [d.won_count, d.not_won], false);
    buildDonut('pieLostTotal', ['Gagal', 'Bukan Gagal'], [d.lost_count, d.not_lost], false);
    buildDonut('pieValue', ['Estimasi Sukses', 'Estimasi Gagal'], [d.won_value, d.lost_value], true);

    const PIE_OFFER_LABELS = {{ (pie_offer_labels or [])|tojson }};
    const PIE_OFFER_VALUES = {{ (pie_offer_values or [])|tojson }};
    if (PIE_OFFER_LABELS.length) buildDonut('pieOfferValue', PIE_OFFER_LABELS, PIE_OFFER_VALUES, true);

    const PIE_SOURCES_LABELS = {{ (pie_sources_labels or [])|tojson }};
    const PIE_SOURCES_VALUES = {{ (pie_sources_values or [])|tojson }};
    if (document.getElementById('pieSources') && PIE_SOURCES_LABELS.length) {
      buildDonut('pieSources', PIE_SOURCES_LABELS, PIE_SOURCES_VALUES, false);
    }

    const PIE_NEEDS_LABELS = {{ (pie_needs_labels or [])|tojson }};
    const PIE_NEEDS_VALUES = {{ (pie_needs_values or [])|tojson }};
    if (document.getElementById('pieNeeds') && PIE_NEEDS_LABELS.length) {
      buildDonut('pieNeeds', PIE_NEEDS_LABELS, PIE_NEEDS_VALUES, false);
    }

    // ---------- Bar Top Sales (biar matching look) ----------
    const barEl = document.getElementById('barTopSales');
    if (barEl){
      new Chart(barEl, {
        type: 'bar',
        data: {
          labels: d.top_sales_labels,
          datasets: [{
            label: 'Jumlah Closing Sukses',
            data: d.top_sales_values,
            borderWidth: 0,
            borderRadius: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(20,20,20,.92)',
              titleColor: '#fff',
              bodyColor: '#fff',
              padding: 10,
              cornerRadius: 10
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { maxRotation: 0, autoSkip: true }
            },
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              grid: { color: 'rgba(0,0,0,.08)' }
            }
          }
        }
      });
    }
  </script>
{% endif %}

<div class="card">
  <div class="card-header">Follow Up Terbaru</div>
  <div class="card-body">
    {% if latest_followups %}
      <ul class="list-group">
        {% for fu in latest_followups %}
          <li class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <div>
                <a href="{{ url_for('customer_detail', customer_id=fu.customer_id) }}">
                  {{ fu.customer.name }}
                </a>
                {% if fu.stage %}<span class="badge badge-accent">{{ fu.stage.name }}</span>{% endif %}
              </div>
              <div class="text-muted small">{{ fu.note or "-" }}</div>
            </div>
            <div class="text-muted small">{{ fu.created_at.strftime("%Y-%m-%d %H:%M") }}</div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="text-muted">Belum ada follow up.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
